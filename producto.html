<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="stylesheet" href="producto.css">
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Producto</title>
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
</head>
<script>
    const frutas = [];
    const verduras = [];
    fetch('stock.json')
    .then(response => response.json())
    .then(data => {
        google.charts.load('current', {'packages':['corechart']});
        google.charts.load('current', {packages: ['corechart', 'bar']});
        const frutasDatos = data.frutas;
        const verdurasDatos = data.verduras;
        google.charts.setOnLoadCallback(frutasStock);
        google.charts.setOnLoadCallback(verdurasStock);
        frutasDatos.forEach(fruta => {
            frutas.push([fruta.nombre, fruta.cantidad]);
        });
        verdurasDatos.forEach(verdura => {
            verduras.push([verdura.nombre, verdura.cantidad]);
        });
        anadirFrutasOpciones();
        anadirVerdurasOpciones();

        function frutasStock(){
            var data = google.visualization.arrayToDataTable([
                ['Frutas', 'Cantidad'],
                ...frutas
            ]);
            var materialOptions = {
                chart: { title: 'Venta anual de frutas por género' },
                hAxis: { title: 'Cantidad vendida', minValue: 0 },
                vAxis: { title: 'Frutas' },
                bars: 'vertical',
            };
            var materialChart = new google.charts.Bar(document.getElementById('frutasStock'));
            materialChart.draw(data, materialOptions);
        }

        function verdurasStock() {
            var data = google.visualization.arrayToDataTable([
                ['Verduras', 'Cantidad'],
                ...verduras
            ]);
            var materialOptions = {
                chart: { title: 'Venta anual de verduras por género' },
                hAxis: { title: 'Cantidad vendida', minValue: 0 },
                vAxis: { title: 'Verduras' },
                bars: 'vertical',
            };
            var materialChart = new google.charts.Bar(document.getElementById('verdurasStock'));
            materialChart.draw(data, materialOptions);
        }
    });
</script>
<body>
    <header>
        <img src="images/iconofrutify.png" alt="Logo">
        <input type="text" placeholder="Buscar producto">
        <div>
            <a href="logueado.html"><input type="button" id="volverAtras" value="Volver"></a>
            <a href="index.html"><input type="submit" id="cerrarSesion" value="Cerrar Sesión"></a>
        </div>
    </header>
    <div class="contenedor">
        <h3>Gráficas de Stock</h3>
        <div id="frutasStock"></div>
        <div id="verdurasStock"></div>
        <div class="botones">
            <label>Seleccionar Fruta</label>
            <select id="selectFruits"></select>
            <label>Cantidad</label>
            <input type="number" id="cantidad_fruta">
            <label>Cliente para la fruta</label>
            <input type="text" id="cliente_fruta">
            <label>Seleccionar Verdura</label>
            <select id="selectVegetables"></select>
            <label>Cantidad</label>
            <input type="number" id="cantidad_verdura">
            <label>Cliente para la verdura</label>
            <input type="text" id="cliente_verdura">
            <button id="comprar">Comprar</button>

            <!-- Añadir -->
            <label>Nombre de la nueva fruta</label>
            <input type="text" id="nombre_nuevo_producto_fruta">
            <label>Cantidad</label>
            <input type="number" id="cantidad_nuevo_producto_fruta">
            <button id="anadir_fruta">Añadir nuevo producto</button>

            <label>Nombre de la nueva verdura</label>
            <input type="text" id="nombre_nuevo_producto_verdura">
            <label>Cantidad</label>
            <input type="number" id="cantidad_nuevo_producto_verdura">
            <button id="anadir_verdura">Añadir nuevo producto</button>

            <!-- Eliminar -->
            <label>Nombre de la fruta a eliminar</label>
            <input type="text" id="eliminar_fru">
            <button id="eliminar_fruta">Eliminar fruta</button>

            <label>Nombre de la verdura a eliminar</label>
            <input type="text" id="eliminar_verd">
            <button id="eliminar_verdura">Eliminar verdura</button>

            <!-- Modificar -->
            <label>Nombre de la fruta a modificar</label>
            <input type="text" id="nombre_stock_fruta">
            <label>Nuevo stock</label>
            <input type="number" id="stock_fruta">
            <button id="modificar_stock_fruta">Modificar stock</button>

            <label>Nombre de la verdura a modificar</label>
            <input type="text" id="nombre_stock_verdura">
            <label>Nuevo stock</label>
            <input type="number" id="stock_verdura">
            <button id="modificar_stock_verdura">Modificar stock</button>
        </div>
    </div>
</body>
<script>
    const nombre = localStorage.getItem('nombre');
    
    function anadirFrutasOpciones(){
        let opcionesFrutas = "";
        const opciones = document.getElementById("selectFruits");
        for(let x = 0; x < frutas.length; x++){
            opcionesFrutas += `<option value='${frutas[x][0]}'>${frutas[x][0]}</option>`;
        }
        opciones.innerHTML = opcionesFrutas;
    }
    function anadirVerdurasOpciones(){
        let opcionesVerduras = "";
        const opciones = document.getElementById("selectVegetables");
        for(let x = 0; x < verduras.length; x++){
            opcionesVerduras += `<option value='${verduras[x][0]}'>${verduras[x][0]}</option>`;
        }
        opciones.innerHTML = opcionesVerduras;
    }
    function comprar() {
    const botonComprar = document.getElementById("comprar");

    botonComprar.addEventListener('click', function () {
        const selectFruits = document.getElementById("selectFruits");
        const selectedOptionFruits = selectFruits.options[selectFruits.selectedIndex];
        const valueSeleccionadoFruta = selectedOptionFruits.value;
        const cliente_fruta = document.getElementById("cliente_fruta").value;

        const selectVegetables = document.getElementById("selectVegetables");
        const selectedOptionVegetables = selectVegetables.options[selectVegetables.selectedIndex];
        const valueSeleccionadoVerdura = selectedOptionVegetables.value;
        const cliente_verdura = document.getElementById("cliente_verdura").value;

        const quantityFruits = parseInt(document.getElementById("cantidad_fruta").value);
        const quantityVegetables = parseInt(document.getElementById("cantidad_verdura").value);

        // Variables para verificar los errores
        let errors = [];

        // Verificación de cantidad de frutas y verduras
        if (isNaN(quantityFruits) || quantityFruits <= 0) {
            errors.push("Por favor, ingresa una cantidad válida para la fruta.");
        }

        if (isNaN(quantityVegetables) || quantityVegetables <= 0) {
            errors.push("Por favor, ingresa una cantidad válida para la verdura.");
        }


        fetch('stock.json')
        .then(response => {
            if (!response.ok) {
                throw new Error('Error al obtener los datos del stock.');
            }
            return response.json();
        })
        .then(data => {
            const frutas = data.frutas;
            const verduras = data.verduras;

            let cantidadFrutasEncontrado = false;
            let cantidadVerdurasEncontrado = false;

            frutas.forEach(fruta => {
                if (quantityFruits <= fruta.cantidad) {
                    cantidadFrutasEncontrado = true;
                }
            });

            verduras.forEach(verdura => {
                if (quantityVegetables <= verdura.cantidad) {
                    cantidadVerdurasEncontrado = true;
                }
            });

           
            fetch('informacion.json')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Error al obtener la información de los clientes.');
                    }
                    return response.json();
                })
                .then(data => {
                    const clientes = data.usuarios;

                    let clienteFrutaEncontrado = false;
                    let clienteVerduraEncontrado = false;

                    clientes.forEach(usuario => {
                        if (usuario.nombre === cliente_fruta) {
                            clienteFrutaEncontrado = true;
                        }
                        if (usuario.nombre === cliente_verdura) {
                            clienteVerduraEncontrado = true;
                        }
                    });

                    if (!clienteFrutaEncontrado) {
                        errors.push("No se ha encontrado el cliente para la venta de la fruta.");
                    }

                    if (!clienteVerduraEncontrado) {
                        errors.push("No se ha encontrado el cliente para la venta de la verdura.");
                    }

                    if (errors.length > 0) {
                        alert(errors.join("\n"));
                        return;
                    }

                    const payload = {
                        frutas: { nombre: valueSeleccionadoFruta, cantidad: quantityFruits, cliente: cliente_fruta },
                        verduras: { nombre: valueSeleccionadoVerdura, cantidad: quantityVegetables, cliente: cliente_verdura }
                    };

                    fetch('http://localhost:3000/comprar/producto', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(payload)
                    })
                    .then(response => response.json())
                    .then(data => {
                        localStorage.setItem('ventaRealizada', true);
                    })
                    .catch(error => {
                        alert("Error al realizar la venta.");
                        console.error(error);
                    });
                })
                .catch(error => {
                    console.error('Error al obtener la información de los clientes: ', error);
                });
        })
        .catch(error => {
            console.error('Error al obtener los datos del stock: ', error);
        });
    });
    const ventaRealizada=localStorage.getItem('ventaRealizada');
    if(ventaRealizada){
        alert("Venta realizada con éxito");
        localStorage.removeItem('ventaRealizada');
    }
}


    comprar();
    function anadirFruta(){
        const botonAnadir = document.getElementById("anadir_fruta");
        botonAnadir.addEventListener('click', function(){
            const nuevoProductoFruta = document.getElementById("nombre_nuevo_producto_fruta").value;
            const cantidadNuevoProductoFruta = document.getElementById("cantidad_nuevo_producto_fruta").value;
            let nuevaURL = `http://localhost:3000/anadir/fruta/${nuevoProductoFruta}/${cantidadNuevoProductoFruta}`;
            fetch(nuevaURL)
            .then(response => response.text())
            .then(data => {})
            .catch(error => console.error(error));
            alert("Registrado con éxito");
        });
    }
    anadirFruta();
    function anadirVerdura(){
        const botonAnadir = document.getElementById("anadir_verdura");
        botonAnadir.addEventListener('click', function(){
            const nuevoProductoVerdura = document.getElementById("nombre_nuevo_producto_verdura").value;
            const cantidadNuevoProductoVerdura = document.getElementById("cantidad_nuevo_producto_verdura").value;
            let nuevaURL = `http://localhost:3000/anadir/verdura/${nuevoProductoVerdura}/${cantidadNuevoProductoVerdura}`;
            fetch(nuevaURL)
            .then(response => response.text())
            .then(data => {})
            .catch(error => console.error(error));
            alert("Registrado con éxito");
        });
    }
    anadirVerdura();

    function eliminarFruta(){
        const botonEliminar = document.getElementById("eliminar_fruta");
        botonEliminar.addEventListener('click', function(){
            const eliminarFruta = document.getElementById("eliminar_fru").value;
            let nuevaURL = `http://localhost:3000/eliminar/fruta/${eliminarFruta}`;
            fetch(nuevaURL)
            .then(response => response.text())
            .then(data => {})
            .catch(error => console.error(error));
            alert("Eliminado con éxito");
        });
    }
    eliminarFruta();

    function eliminarVerdura(){
        const botonEliminar = document.getElementById("eliminar_verdura");
        botonEliminar.addEventListener('click', function(){
            const eliminarVerdura = document.getElementById("eliminar_verd").value;
            let nuevaURL = `http://localhost:3000/eliminar/verdura/${eliminarVerdura}`;
            fetch(nuevaURL)
            .then(response => response.text())
            .then(data => {})
            .catch(error => console.error(error));
            alert("Eliminado con éxito");
        });
    }
    eliminarVerdura();

    function modificarStockFruta(){
        const botonStock = document.getElementById("modificar_stock_fruta");
        botonStock.addEventListener('click', function(){
            const nombreStockFruta = document.getElementById("nombre_stock_fruta").value;
            const stockFruta = document.getElementById("stock_fruta").value;
            let nuevaURL = `http://localhost:3000/modificar/stock_fruta/${nombreStockFruta}/${stockFruta}`;
            fetch(nuevaURL)
            .then(response => response.text())
            .then(data => {})
            .catch(error => console.error(error));
            alert("Stock modificado con éxito");
        });
    }
    modificarStockFruta();

    function modificarStockVerdura(){
        const botonStock = document.getElementById("modificar_stock_verdura");
        botonStock.addEventListener('click', function(){
            const nombreStockVerdura = document.getElementById("nombre_stock_verdura").value;
            const stockVerdura = document.getElementById("stock_verdura").value;
            let nuevaURL = `http://localhost:3000/modificar/stock_verdura/${nombreStockVerdura}/${stockVerdura}`;
            fetch(nuevaURL)
            .then(response => response.text())
            .then(data => {})
            .catch(error => console.error(error));
            alert("Stock modificado con éxito");
        });
    }
    modificarStockVerdura();
</script>
</html>